# IPsec (Internet Protocol Security)

**IPsec (Internet Protocol Security)** — это **набор протоколов** для обеспечения безопасности данных, передаваемых по IP-сетям. IPsec используется для шифрования, аутентификации и обеспечения целостности данных, а также для защиты от атак типа "man-in-the-middle".

## Основные компоненты IPsec

Для начала нужно уяснить себе, что IPSec – это не протокол, это стандарт, включающий в себя целых **три протокола**, каждый со своими функциями:

- **AH (Authentication Header – заголовок аутентификации)** отвечает за аутентификацию источника и проверку целостности данных, но не шифрование
- **ESP (Encapsulating Security Payload – безопасная инкапсуляция полезной нагрузки)** занимается непосредственно шифрованием данных, а также может обеспечивать аутентификацию источника и проверку целостности данных
- **IKE (Internet Key Exchange protocol – протокол обмена ключами)** используется для формирования **IPSec SA (Security Association)**, проще говоря, согласования работы участников защищенного соединения. *Используя этот протокол, участники договариваются, какой алгоритм шифрования будет использоваться, по какому алгоритму будет производиться (и будет ли вообще) проверка целостности, как аутентифицировать друг друга.*

-----------

## SA – Security Association

Прежде чем переходить дальше, разберемся с термином **SA – Security Association**. **SA** в общем смысле представляет собой набор параметров защищенного соединения (например, алгоритм шифрования, ключ шифрования), который может использоваться обеими сторонами соединения. У каждого соединения есть ассоциированный с ним **SA**.

-----------

## Создание IPsec соединения

### Security Association

Для начала, участникам надо договорится, какие алгоритмы/механизмы защиты они будут использовать для своего защищенного соединения, поэтому в дело вступает **IKE**. Процесс состоит из двух фаз:

- **Фаза первая**: он называется **ISAKMP Tunnel**. Участники аутентифицируют друг друга и договариваются о параметрах установки специального соединения (тоже защищенного), предназначенного только для обмена информацией о желаемых/поддерживаемых алгоритмах шифрования и прочих деталях будущего **IPSec-туннеля**
- **Фаза вторая**: уже доверяющие друг другу участники договариваются о том, как строить основной туннель для данных. Они по очереди предлагают друг другу варианты, указанные в команде **crypto ipsec transform-set**, и, если приходят к согласию, поднимают основной туннель. Нужно сказать, что, после его установления, вспомогательный **ISAKMP** туннель никуда не пропадает – он используется для обновления **SA** основного.

### Transform-set

Теперь немного о трансформ-сете и чем отличается **ESP** от **AH**. Как будут шифроваться наши данные, идущие через туннель, определяет команда **crypto ipsec transform-set имясета_**, после которой идет название протокола, который будет использован (**ESP** или **AH**) + алгоритм, по которому будет работать протокол. Например, команда **crypto ipsec transform-set SET1 esp-aes** даст понять роутеру, что трансформ-сет с именем “SET1”, если он будет применен, будет работать только по протоколу **ESP** c шифрованием алгоритмом **AES**.

> Что такое AH и зачем он вообще нужен?  AH обеспечивает аутентификацию данных, то есть дает уверенность, что эти данные пришли именно от того, с кем мы установили связь, и не были изменены по дороге.

-------------

## Два режима работы

**IPSec** может работать в двух режимах: **туннельном** и **транспортном**.

### Туннельный режим работы IPSec

В этом режиме берётся ваш изначальный IP-пакет, шифруется полностью, вместе с заголовком IP, добавляется служебная информация IPSec и новый заголовок IP.

Какую самую главную проблему мы имеем тут? Бинго! *Динамическая маршрутизация*. Внедрить её в таких условиях невозможно – все **IGP** требуют прямого L2-линка между соседями, чего не обеспечивает **IPSec**. Поэтому в такой реализации трафик отправляется в туннель на основе **ACL** и карты шифрования, а не таблицы маршрутизации.
Плюс мы имеем проблему с мультикастом, потому что задаём конкретные подсети в **ACL**.

### Транспортный режим работы IPSec

Он много чем отличается от туннельного, но самое важное – это метод инкапсуляции. 
То есть туннельный шифрует изначальный пакет полностью и добавляет новый заголовок IP. Транспортный же шифрует всё, что выше уровня IP, а заголовок **IP** оставляет без изменений.
Грубо говоря, туннельный режим вы используете для того, чтобы связать две приватные сети через публичную, обеспечив при этом шифрование (Что-то вроде безопасного **GRE**). Транспортный же актуален тогда, когда **IP-связность** уже достигнута, но трафик между узлами нужно шифровать.

-----------

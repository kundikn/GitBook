 # GRE over IPSec

Обычный режим, который мы рассматриваем тут и который применяется в подавляющем большинстве случаев, – это **GRE over IPSec**, то есть данные **GRE** инкапсулируются заголовками **ESP** или **AH**.
А **IPSec over GRE** означает, наоборот, что внутри будут зашифрованные данные **IPSec**, а сверху заголовки **GRE/IP**. *Они будут не зашифрованы.*

> Зачем такая пахабщина нужна, не очень понятно, поэтому обычно используется именно GRE over IPSec.

-------------

## Принцып работы

Создаем интерфейс tun для **GRE**, то есть просто создаем тунель с помощью **GRE**. И создаем статический маршрут через тунель до нужной сети. 

**Во-первых**, поскольку туннель уже существует (**GRE**), нет нужды делать его ещё и средствами **IPSec** – можно перевести его в транспортный режим, тем самым, сэкономив *20 байтов* на лишнем IP-заголовке:

~~~
crypto ipsec transform-set AES128-SHA esp-aes esp-sha-hmac
mode transport
~~~

Во-вторых, шифроваться должен весь трафик между филиалами, то есть тот, который идёт через туннель, соответственно, нет необходимости прописывать все сети в **ACL**, поступим хитрее:

~~~
access-list 101 permit gre host 100.0.0.1 host 200.0.0.1
~~~

*Условие выполняется, если на порт пришёл трафик с заголовком GRE и соответствующими адресами.*

### Что будет происходить при таком раскладе?

1. Пакет с адресом назначения 10.1.1.0 приходит на маршрутизатор, тот определяет по своей таблице, что пакет нужно передать на next-hop 10.2.2.2
2. Это туннельный интерфейс, с адресом назначения 200.0.0.1. Пакет упаковывается заголовком **GRE** и новым **IP-заголовком**.
3. Сеть 200.0.0.1 известна через адрес 100.0.0.2, а подсеть 100.0.0.0/30 подключена к интерфейсу FE0/0. А на него применена карта шифрования с ACL. Трафик, естественно, подпадает под него (имеет заголовок **GRE** и нужные **IP-адреса**), поэтому всё, что находится внутри внешнего IP-заголовка будет зашифровано.*Такая схема работы позволяет нормально внедрять протоколы динамической маршрутизации.* 

----------------


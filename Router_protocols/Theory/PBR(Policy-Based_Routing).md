# PBR (Policy-Based Routing)

Что, если мы хотим маршрутизировать пакет, отталкиваясь от адреса источника? Или нам нужно мальчики **HTTP** направо, девочки **SNMP** налево?

В такой ситуации нам приходит на помощь маршрутизация на базе политик ака **PBR (Policy based routing).** 

Эта технология позволяет нам управлять трафиком, базируясь на следующих признаках пакета:

- Адрес источника (или комбинация адрес источника-адрес получателя)
- Информация 7 уровня (*приложений*) **OSI**
- Интерфейс, в который пришел пакет
- **QoS-метки**
- Вообще говоря, любая информация, используемая в **extended-ACL** (*порт источника\получателя, протокол и прочее, в любых комбинациях*). Т.е. если мы можем выделить интересующий нас трафик с помощью расширенного **ACL**, мы сможем его смаршрутизировать, как нам будет угодно.

**Минусы:**

- Все нужно писать руками, отсюда много работы и риск ошибки
- Производительность.

Политика, на основе которой осуществляется **PBR**, создается командой **route map POLICY_NAME**, и содержит два раздела:

- Выделение нужного трафика. Осуществляется либо с помощью **ACL**, либо в зависимости от интерфейса, в который трафик пришел. За это отвечает команда **match** в режиме конфигурации **route map**
- Применение действия к этому трафику. За это отвечает команда **set**

---------

## Пример

На данный момент трафик *R1-R5* и обратно идет по маршруту *R1-R2-R4-R5*, а надо реализовать, чтобы обратно шел через *R5-R4-R3-R1*.

На нем сначала создаем **ACL**, который отбирает нужные нам пакеты (тут **ip addres** интерфейса, от которого приходят пакеты на *R4*)

```
R4(config)#access-list 100 permit ip host 192.168.100.5 any
```

Затем создаем политику маршрутизации с именем “BACK”

```
R4(config)#route-map BACK
```

Внутри нее говорим, какой трафик нас интересует

```
R4(config-route-map)#match ip address 100
```

И что с ним делать

```
R4(config-route-map)#set ip next-hop 192.168.3.3
```

Вообще, вот все что может делать **set**:

- **set ip next-hop**
- **set interface**	
- **set ip default next-hop**	
- **set default interface**

**Default** - если есть маршрут, то будет идти через него, если нет, то как обычно.

После чего заходим на интерфейс, который смотрит в сторону *R5* (**PBR работает с входящим трафиком!**) и применяем на нем полученную политику

```
R4(config-if)#ip policy route-map BACK
```

-----------

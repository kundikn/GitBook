# Управление маршрутами BGP

Необходимо разобраться с тем, каким образом мы вообще можем управлять маршрутами в этом протоколе:

- **AS-Path ACL**
- **Prefix-list**
- **Weight**
- **Local Preference**
- **MED**

Но только первые два из них позволяют фильтровать анонсируемые или принимаемые маршруты. Три другие это значения приоритетов, с помощью которых можно фильтровать маршруты.

-----

## AS-Path ACL

Управление на основе **AS-Path**. Правила могут включать в себя совпадения с определенными **AS** или шаблонами **AS-Path**.

Самое сложное в таком подходе – запомнить все регулярные выражения и научиться их использовать:

- До и после номера **AS** идут знаки **“_”,** означающие, что в **AS-Path** номер *200* может стоять в начале, середине или конце, главное, чтобы он был.
- **“^”** означает начало списка, а **“$” – конец**. То есть если в **AS-Path** всего лишь один номер **AS** – это означает, что маршрут был зарождён в **AS 200** и оттуда сразу был передан нам.
- **“$”** означает конец списка, то есть это самая первая **AS**, из неё маршрут и зародился, знак **“_”** говорит о том, что неважно, что находится дальше, хоть ничего, хоть 7 других **AS.**
- Знак **“^”** означает, что **ASN 200** была добавлена последней, то есть маршрут к нам пришёл из **AS 200**, но это не значит, что родился он в ней же – знак **“_”** говорит о том, что это может быть конец списка, а может пробел перед следующей **AS**.
- Список **AS-Path** пуст, значит маршрут локальный, сгенерированный внутри нашей **AS**.

**Регулярные выражения:**

- **"."** любой символ, включая пробел
- **"*"** ноль или больше совпадений с выражением
- **"+"** одно или больше совпадений с выражением
- **"?"** ноль или одно совпадение с выражением
- **"^"** начало строки
- **"$"** конец строки
- **"_"** любой разделитель (включая, начало, конец, пробел, табуляцию, запятую)
- **\** не воспринимать следующий символ как специальный
- **[]** совпадение с одним из символов в диапазоне
- **|** логическое или

**Примеры регулярных выражений:**

- **^8_** - сети, которые находятся за автономной системой 8
- **_67\_** - маршруты проходящие через автономную систему 67
- **^[0-9]+$** - AS-Path = 1
- **^[0-9]+_[0-9]+$** - AS-Path = 2
- **^100.*200$** - начинается со 100 заканчивается 200

-------

*Для того чтобы проверить отработает ли регулярное выражение так, как предполагалось*

```
show ip bgp regexp <regexp>
```

*Создание фильтра*

```dyn(config)# ip as-path access-list 1 <permit | deny> regexp 
dyn(config)# ip as-path access-list 1 <permit | deny> regexp
```

*Пример настройки фильтра*

```
dyn(config)# ip as-path access-list 1 permit ^8_
dyn(config)# ip as-path access-list 1 permit _67_
```

*Отобразить все настроенные фильтры или конкретный фильтр*

```
dyn# show ip as-path-access-list [number]
```

*Применение фильтра*

````
dyn(config-router)# neighbor <ip-address | peer-group-name>  filter-list <acl-number> <in | out>
````

---------

## Prefix List

**Префикс-листы** – это просто привычные нам сеть/маска, и мы указываем разрешить такие маршруты или нет.

```
ip prefix-list {list-name} [seq {value}] {deny|permit} {network/length} [ge {value}] [le {value}]
```

где:

- **list-name** – название списка. Ваш КО. Обычно указывается, как **name_in** или **name_out**. Это подсказывает нам на *входящие или исходящие* маршруты будет действовать (но, конечно, на данном этапе никак не определяет).
- **seq** – порядковый номер правила (как в **ACL**), чтобы проще было оперировать с ними.
- **deny/permit** – определяем разрешать такой маршрут или нет
- **network/length** – привычная для нас запись, вроде, *192.168.14.0/24*.
- А вот дальше, внимание, сложнее – возможны ещё два параметра: **ge** и **le**. Как и при настройке **NAT** (или в ЯП Фортран), это означает "**greater or equal**" и "**less or equal**", *то есть вы можете задать не только один конкретный префикс, но и их диапазон*.

**Пример**

Запретить AS 64500 принимать маршруты ото всех кроме 64501:

```
R1#sh ip prefix-list
ip prefix-list FILTER_IN: 2 entries
   seq 1 permit 10.10.10.0/24
   seq 2 deny 0.0.0.0/0 le 32

neighbor 10.10.10.2 prefix-list FILTER_IN in
```

-----------

## Route Map

С помощью карт маршрутов (у других вендоров они могут называться политиками маршрутизации) мы можем очень гибко применять правила, дифференцируя анонсы.

```
route-map {map_name} {permit|deny} {seq} [match {expression}] [set {expression}]
```

где:

- **map_name** – имя карты

- **permit/deny** – разрешаем или нет прохождение данных, подпадающих под условия route-map

- **seq** – номер правила в **route-map**

- **match** – условие подпадания трафика под данное правило. **expression**:

  - **Network/mask** - match ip address prefix-list

  - **AS-Path** - match as-path

  - **BGP community** - match community

  - **Route originator** - match ip route-source

  - **BGP next-hop address** - match ip next-hop

- set – что сделать с отфильтрованными маршрутами. **expression**:

  - **AS path prepend** - set as-path prepend
  - **Weight** - set weight
  - **Local Preference** - set local-preference
  - **BGP community** - set community
  - **MED** - set metric
  - **Origin** - set origin
  - **BGP next-hop** - set next-hop

*Допустим у нас есть два пути на получателя, для одного мы можешь сделать local preference меньше, значит маршрут будет менее предпочтительней:*

```
Сеть назначения
ip prefix-list P1 seq 5 permit 192.168.102.0/24

route-map M1 permit 10
 match ip address prefix-list P1
 set local-preference 50
!
Это правильо применяется для всех маршрутов
route-map M1 permit 20
 set local-preference 100

Привязываем к нужному соседу карту
neighbor 10.10.12.1 route-map M1 in

```

-----


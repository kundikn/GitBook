# Балансировка и распределение нагрузки BGP

В BGP балансировка и распределение – это две большие разницы. 

## Балансировка нагрузки

Под балансировкой обычно понимается распределение между несколькими линками трафика, направленного в одну сеть. Балансировка обычно осуществляется на базе потоков. 

Включается она просто:

```
router bgp 100
	maximum-paths 2
```

При этом должны выполняться следующие условия:

- Не менее двух маршрутов в таблице **BGP** для этой сети.

- Оба маршрута идут через одного провайдера

- Параметры **Weight**, **Local Preference**, **AS-Path**, **Origin**, **MED**, метрика **IGP** совпадают.

- Параметр **Next Hop** должен быть разным для двух маршрутов.

  ```
  router bgp 64500
  		bgp bestpath as-path multipath-relax
  ```

По умолчанию никак не учитывается пропускная способность внешних каналов. Такая возможность однако реализована и запускается командами:

```
router bgp 64500
	bgp dmzlink-bw
	neighbor 101.0.0.1 dmzlink-bw
	neighbor 102.0.0.1 dmzlink-bw
```

------------

## Распределение нагрузки

Это более тонкая настройка путей исходящего и входящего трафика. Исходящий трафик направляется в соответствии с маршрутами, полученными свыше. Соответственно ими и надо управлять. 

Итак, есть следующие способы:

- Настройка **Weight**. *Это цисковский внутренний параметр* – никуда не передаётся – работает в пределах маршрутизатора. 
- **Local Preference**. Это параметр стандартный. *По умолчанию 100* для всех маршрутов. Если вы хотите трафик на определённые подсети направлять в определённые линки, то **Local Preference** незаменим.
- Вышеуказанная балансировка командой **maximum-paths**.

### AS-Path Prepend

Один из самых частых приёмов – “*ухудшение*” пути. Можно короткому пути приписать **дополнительные хопы**, обычно прописывают свою же **AS**, можно и *чужую, но в приличном обществе вас не поймут*.

Если мы хотим *ухудшить основной путь* (прямой линк между ними), то нужно добавить **AS** в список **AS-Path**

	router bgp 64500
		neighbor 101.0.0.1 route-map AS_PATH_PREP out
		
	route-map AS_PATH_PREP permit 10
	set as-path prepend 64500 64500

### MED (Multiexit Discriminator)

В **Cisco** он называется метрикой (**Inter-AS** метрика). **MED** является слабым атрибутом. Слабым, потому что он проверяется лишь на шестом шаге при выборе маршрута и оказывает *по сути слабое влияние*.
Если **Local Preference** влияет на выбор пути выхода трафика из Автономной системы, то **MED** передаётся в соседние **AS** и таким образом влияет на пути входа трафика.

|                       Local Preference                       | MED                                                          |
| :----------------------------------------------------------: | ------------------------------------------------------------ |
|       Определяет приоритет пути для **выхода** трафика       | Определяет приоритет пути для **входа** трафика              |
| Действует только внутри **AS**. Никак не передаётся в другие **AS** | Передаётся в другие **AS** и намекает через какой путь передавать трафик предпочтительнее |
|        Может работать при подключении к разным **AS**        | Работает только при нескольких подключениях к одной **AS**   |
|           Чем больше значение, тем выше приоритет            | Чем больше значение, тем ниже приоритет                      |

### Анонс разных префиксов через разных ISP

Ещё один способ распределить нагрузку – раздавать разные сети разным провайдерам. **Процесс муторный**. Мы можем разделить сеть допустим 100.0.0.0/23 на две подсети /24 и отдавать ее разным **AS**. 

Настраивается это так.

1. Мы прописываем все свои подсети – все 3: одну большую /23 и две маленькие /24:

   ```
   router bgp 64500
   	network 100.0.0.0 mask 255.255.254.0
   	network 100.0.0.0 mask 255.255.255.0
   	network 100.0.1.0 mask 255.255.255.0
   ```

2. Для того, чтобы они могли быть анонсированы, нужно создать маршруты до этих подсетей (в книге без этого не работает, но у меня почему то работает). Типа это ничего не меняет, но сети должны быть анонсированы. 

   ```
   ip route 100.0.0.0 255.255.254.0 Null0
   ip route 100.0.0.0 255.255.255.0 Null0
   ip route 100.0.1.0 255.255.255.0 Null0
   ```

3. А теперь создаём префикс-листы, которые разрешают каждый только одну подсеть /24 и общую /23.

   ```
   ip prefix-list LIST_OUT1 seq 5 permit 100.0.0.0/24
   ip prefix-list LIST_OUT1 seq 10 permit 100.0.0.0/23
   ! 
   ip prefix-list LIST_OUT2 seq 5 permit 100.0.1.0/24
   ip prefix-list LIST_OUT2 seq 10 permit 100.0.0.0/23
   ```

4. Осталось привязать префикс-листы к соседям.

   ```
   router bgp 64500
   	neighbor 101.0.0.1 remote-as 64501
   	neighbor 101.0.0.1 prefix-list LIST_OUT1 out
   	neighbor 102.0.0.1 remote-as 64502
   	neighbor 102.0.0.1 prefix-list LIST_OUT2 out
   ```

   *Привязываем мы их на OUT – на исходящий, потому что речь о маршрутах, которые мы отправляем вовне.* Теперь осталось ответить на вопрос какого лешего мы тащили за собой большую подсеть /23? Ведь согласно правилу Longest prefix match более точные маршруты предпочтительней, то есть /23, как бы и не нужен, когда есть /24.

   > Существуют также специальные организации, которые отслеживают анонсы BGP в Интернете и, если вдруг происходит что-то неожиданное, может уведомить владельца сети. Подсеть 100.0.0.0/24 перестанет быть известной в интернете – ведь только Балаган Телеком что-то знал о ней благодаря нашей настройке. Соответственно, ляжет и часть нашей сети. Но! Нас спасает более общий маршрут 100.0.0.0/23. Филькин Сертификат знает о нём и анонсирует его в Интернет. Соответственно, хоть ЦОД и не знает про сеть 100.0.0.0/24, он знает про 100.0.0.0/23 и пустит трафик в сторону Филькина Сертификата.
   > Надо иметь ввиду, что помимо настройки маршрутизатора вам придётся завести все три сети в базе данных RIPE. Там должны быть и обе сети /24 и сеть /23.

 ### BGP Community

C помощью BGP Community можно давать провайдеру указания, что делать с префиксом, кому передавать, кому нет, какой local preference у себя ставить и т.д. *?????????*

----------

# BGP (Border Gateway Protocol)

## Понятие автономной системы (AS) и как устроен интернет

**Автономная система** - это система IP-сетей и маршрутизаторов, управляемых одним или несколькими операторами, имеющими единую политику маршрутизации с Интернетом. Две **АС** связываются между собой **BGP**.
В **BGP** **AS** – это не просто какая-то абстрактная вещь для удобства. Выдачей этих номеров занимаются **RIR** (**Regional Internet Reistry**) или **LIR** (**Local Internet Registry**).

Вообще глобально этим занимается **IANA**. Но чтобы не разорваться, она делегирует свои задачи **RIR** – это региональные организации, каждая из которых отвечает за определённую часть планеты (*Для Европы и России – это RIPE NCC*)
**LIR** нужны для того, чтобы **RIR’у** не пришлось напрягаться с запросами от таких мелких контор. С каждой **AS** должен быть связан какой-то блок адресов.

На самом деле **PI** – это **Provider Independent**. При обычном подключении к провайдеру он выдает вам  **PA-адреса** **(Provider Aggregatable**) - *обычные публичные адреса*. И если вы решите сменить провайдера, то старые адреса уйдут вместе с ним.
У **LIR** вы можете приобрести провайдеро-независимый блок адресов (**PI**) и обязательно **ASN**.

Хорошая подробная [статья](https://habr.com/ru/articles/55181/).

---------

## Разница между BGP и другими протоколами IGP

Теперь главный вопрос, который интересует всегда новичков: а зачем **BGP**, почему не взять пресловутый **OSPF** или вообще **статику**?

1. Если говорить о **OSPF/IS-IS**, то это **Link-State** алгоритмы, которые подразумевают (**внимание!**), что каждый маршрутизатор знает топологию всей сети. Представляем себе миллионы маршрутизаторов в Интернете и отказываемся от идеи использовать **Link State**.
2. **RIP**, **EIGRP**… *Кхе-кхе*. Ну, тут всё понятно. Ограничение в 15 хопов, а **EIGRP** вообще проприетарный протокол **cisco**.
3. Дело в том, что **IGP** не имеют достаточно гибкой системы управления маршрутами – для **LS-протоколов** это вообще знать всё или ничего (опять же можно фильтровать на границе зоны, но гибкости никакой).

Поэтому нужен свой специальный протокол для взаимодействия между ***AS***, который будет включать следующее:

1. Он должен быть **distance vector** – это однозначно.
2. Он должен иметь очень гибкую систему фильтрации маршрутов. 
3. Он должен быть легко масштабируемым, иметь защиту от образования петель и систему управления приоритетами маршрутов.
4. Он должен обладать высокой стабильностью.

Вот он - **BGP**!

---------

## BGP - IBGP и EBGP

**BGP** делится на **IBGP** и **EBGP**.

**IBGP** необходим для передачи **BGP-маршрутов** внутри одной автономной системы.
**EBGP** – это обычный **BGP** между автономными системами. 

---------------------

## Установление отношений в BGP

**BGP** не обнаруживает соседей автоматически – каждый сосед настраивается вручную.
Процесс установления отношений соседства происходит следующим образом:

1. Изначальное состояние **BGP-соседства** – **IDLE**, если нет маршрута к **BGP-соседу**. Ничего не происходит.

2. Для обеспечения надёжности **BGP** использует **TCP**. **BGP-маршрутизатор** (их также называют **BGP-спикерами/speaker** или **BGP-ораторами**) слушает и посылает пакеты на **179-й** **TCP** порт. Когда слушает – это состояние **CONNECT**. В таком состоянии **BGP** находится очень недолго. Когда отправил и ожидает ответа от соседа – это состояние **ACTIVE**. Потом идет стандартная процедура установки TCP сессии.

3. После того, как **TCP-сессия** установлена, **BGP-ораторы** начинают обмен сообщениями **OPEN**. **OPEN** – первый тип сообщений **BGP**. Они отсылаются только в самом начале **BGP-сессии** для согласования параметров.  В нём передаются версия протокола, номер **AS**, **Hold Timer** и **Router ID**. Чтобы **BGP-сессия** поднялась, должны соблюдаться следующие условия:

   - Версии протокола должна быть одинаковой. Маловероятно, что это будет иначе
   - Номера **AS** в сообщении **OPEN** должны совпадать с настройками на удалённой стороне
   - **Router ID** должны различаться

   Получив **OPEN** от R1, R2 отправляет свой **OPEN**, а также **KEEPALIVE**, говорящий о том, что **OPEN** от R1 получен – это сигнал для R1 переходить к следующему состоянию – **Established**.   

   Сообщения **NOTIFICATION**. Они отправляются в случае каких-либо проблем, чтобы разорвать сессию.

   Когда сообщение **OPEN** отправлено – это состояние **OPEN SENT**.

   Когда оно получено – это сотояние **OPEN CONFIRM**.

   Если **Hold Timer** различается, то выбран будет *наименьший*. Поскольку **Keepalive Timer** не передаётся в сообщении **OPEN**, он будет рассчитан автоматически (**Hold Timer/3**). То есть **Keepalive** может различаться на соседях.

4. После всех этих шагов они переходят в стабильное состояние **ESTABLISHED**. Это означает, что запущена правильная версия **BGP** и все настройки консистентны.

5. В первые мгновения после установки **BGP-сессии** в таблице **BGP** только информация о локальных маршрутах. Можно переходить к обмену маршрутной информацией, для этого используются сообщения **UPDATE**:

   - Каждое сообщение **UPDATE** может нести информацию об одном новом маршруте или о удалении группы старых. Причём одновременно.
   - **UPDATE** передаются при каждом изменении в сети до тех пор, пока длится **BGP-сессия**.

   **KEEPALIVE** – это своеобразные подтверждения, что информация получена.

6. Теперь, когда всё хорошо, каждый **BGP-маршрутизатор** регулярно будет рассылать сообщения **KEEPALIVE**. Как и в любом другом протоколе это означает: «*Я всё ещё жив*». Ещё один тип сообщений **BGP** – **ROUTE REFRESH** – позволяет запросить у своих соседей все маршруты заново без рестарта **BGP-процесса**.

------

## Таблица маршрутов BGP

Что из себя представляет таблица маршрутов **BGP** на маршрутизаторе R1: маршрут представляет из себя вовсе не только **NextHop** или просто список устройств до нужной подсети. Это список **AS**. Иначе он называется **AS-Path**.
*То есть, чтобы попасть в сеть 192.168.102.0/24 мы должны отправить пакет наружу, преодолеть AS 64501.*

![image-20241003125930832](C:\Users\kundik.nikita\AppData\Roaming\Typora\typora-user-images\image-20241003125930832.png)

**AS-Path** формируется следующим образом:

1. Пока маршрут гуляет внутри **AS**, список пустой. Все маршрутизаторы понимают, что полученный маршрут из этой же **AS**
2. Как только маршрутизатор анонсирует маршрут своему внешнему соседу, он добавляет в список **AS-Path** номер своей **AS**.
3. Внутри соседской **AS**, список не меняется и содержит только номер изначальной **AS**
4. Когда из соседской **AS** маршрут передаётся дальше в начало списка добавляется номер текущей **AS**. И так далее. При передаче маршрута внешнему соседу номер **AS** всегда добавляется в начало списка **AS-path**. То есть фактически это стек.

**AS-Path** нужен для:

1. Предотвращение петель маршрутизации. В **AS-Path** не должно быть повторяющихся номеров
2. Выбор наилучшего маршрута. Чем короче AS-Path, тем предпочтительнее маршрут, но об этом позже.

--------

## Full View и Default Route

То, что вы видели до сих пор – это так называемый **Full View** – маршрутизатор изучает абсолютно все маршруты Интернета, пусть даже в нашем случае это пять-шесть штук. *В реальности их сейчас больше 400 000*.

### Full View

- Вы обладаетe полным чистейшим знанием о структуре Интернета. До любого адреса в Интернете вы можете просмотреть путь от себя
- Вы знаете, какие к нему ведут **AS**. Через сайт **RIPE** можно посмотреть какие провайдеры обеспечивают транзит. *Вы следите за всеми изменениями.* Если вдруг у кого-то что-то упадёт через первый линк (даже не у вас или у провайдера, а где-то там, дальше), **BGP** это отследит и перестроит свою таблицу маршрутизации для передачи данных через второго провайдера.
- При этом вы очень гибко можете управлять маршрутами, вмешиваясь в стандартную процедуру выбора наилучшего пути. Например, весь трафик на яндекс вы будете пускать через Балаган Телеком, а на гугл через Филькин Сертификат. Это называется распределением нагрузки.

**Full View** обязателен, если ваша **АС** *транзитная*, то есть вы собираетесь по **BGP** подключать к себе ещё клиентов.
Платить за все эти плюсы приходится производительностью: *высокая утилизация оперативной памяти* и *весьма долгое изучение маршрутной информации* после установления **BGP-сессии**. Например, после того, как дёрнулся линк с вышестоящим провайдером, *полное восстановление может занять несколько минут*.

### Default Route

- Сильно экономит ресурсы вашего оборудования.
- Проще в обслуживании, можно сказать. Не нужно по всей своей **AS** гонять сотни тысяч маршрутов.
- Никакого представления о состоянии интернета и реальной доступности получателей нет – вы просто слепо доверяетесь дефолту, полученному от апстрима. То есть в случае проблемы выше, вы о ней не узнаете и часть сервисов может упасть. Но тут мы надеемся, что у вышестоящих провайдеров надёжность сети на порядки выше и нам не о чем беспокоиться.
- *Балансировка и распределение* входящего трафика при получении маршрута по умолчанию никак не затрагивается – проблемы те же. А вот с исходящим, конечно, всё, немного иначе, былой гибкости тут уже не будет.

--------------

## Полезные ресурсы

[Looking Glass](https://www.bgp4.as/looking-glasses/) - Одним из очень мощных инструментов работы с **BGP** – **Looking Glass**. Это сервера, расположенные в Интернете, которые позволяют взглянуть на сеть извне: проверить доступность, просмотреть через какие AS лежит путь в вашу автономную систему, запустить трассировку до своих внутренних адресов.

------------------

## Типы сообщений в BGP

- **Open** - используется для установления соединения между соседними **BGP маршрутизаторами**.
- **Update** - передает информацию о маршрутах, включая анонсы новых маршрутов и отзывы старых.
- **Notification** - отправляется для уведомления о возникших ошибках и закрытия соединения.
- **Keepalive** - используется для поддержания активности соединения между маршрутизаторами.
- **Route-Refresh** - используется для запроса передачи обновленной информации о маршрутах от соседа.

----------

## Состояния маршрутизаторов BGP

- **Idle** - начальное состояние, в котором маршрутизатор инициализирует соединение и ожидает команды на запуск.
- **Connect** -  маршрутизатор пытается установить **TCP** соединение с соседом.
- **Active** -  маршрутизатор пытается установить **TCP** соединение, если предыдущая попытка не удалась.
- **OpenSent** - маршрутизатор отправил сообщение **Open** и ожидает ответ от соседа.
- **OpenConfirm** - маршрутизатор получил сообщение **Open** от соседа и ожидает сообщения **Keepalive**.
- **Established** - соединение установлено, маршрутизаторы обмениваются сообщениями **Update, Keepalive и Notification**.

---------

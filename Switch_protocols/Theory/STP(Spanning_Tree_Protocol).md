# STP (Spanning Tree Protocol)

**STP (Spanning Tree Protocol)** — это сетевой протокол, используемый для предотвращения петель в топологии **Ethernet-сетей**. Петли могут возникнуть в сети *с избыточными путями между коммутаторами* и приводить к *широковещательным штормам*, *дублированию кадров* и *нестабильности сети*. **STP** обеспечивает безопасную и надежную работу сети, *автоматически блокируя избыточные пути* и сохраняя *только один активный путь* для каждого сегмента сети.

--------

## Основные функции и концепции STP

### Предотвращение петель

**STP** обнаруживает избыточные пути в сети и блокирует их, сохраняя один активный путь к каждому узлу. Это предотвращает появление петель, которые могут привести к многократной передаче одного и того же кадра по сети, что вызывает перегрузку и потерю данных.

### Алгоритм STP

**STP** использует алгоритм **Spanning Tree Algorithm** (**STA**), который создает логическую структуру **древовидной топологии** (**spanning tree**) внутри сети. **STA** выбирает корневой коммутатор (**root bridge**) и *определяет кратчайшие пути от всех коммутаторов к корневому коммутатору*.

### Типы портов в STP

- **Root Port** (*корневой порт*): Порт на коммутаторе, который ведет к корневому коммутатору и используется для передачи трафика в направлении корня.
- **Designated Port** (*назначенный порт*): Порт, который выбран для передачи трафика на каждом сегменте сети и не является заблокированным.
- **Blocked Port** (*заблокированный порт*): Порт, который блокируется *для предотвращения петель*. Он не участвует в передаче трафика, но может стать активным, если текущий активный путь выходит из строя.
- **Portfast** - сразу состояние ***forwarding***.

### Состояния портов

- **Блокировка (blocking)**: блокированный порт не шлет ничего. Это состояние предназначено, как говорилось выше, *для предотвращения петель* в сети. Блокированный порт, тем не менее, слушает **BPDU** (чтобы быть в курсе событий, это позволяет ему, когда надо, разблокироваться и начать работать)
- **Прослушивание (listening):** порт слушает и начинает сам отправлять **BPDU**, кадры с данными не отправляет.
- **Обучение (learning)**: порт слушает и отправляет **BPDU**, а также вносит изменения в **CAM-таблицу** (**Content Addressable Memory** это таблица в коммутаторе, которая используется для сопоставления **MAC-адресов** с **портами** коммутатора), но данные не перенаправляет.
- **Перенаправление/пересылка (forwarding)**: этот может все: и **посылает/принимает BPDU**, и с **данными оперирует**, и у**частвует в поддержании таблицы mac-адресов**. То есть это обычное состояние рабочего порта.
- **Отключен (disabled)**: состояние **administratively down**, отключен командой **shutdown**. Понятное дело, ничего делать не может вообще, пока вручную не включат.

### Корневой коммутатор (Root Bridge)

Корневой коммутатор выбирается на основе его **Bridge ID**, который состоит из приоритета коммутатора и его **MAC-адреса**. Коммутатор с наименьшим **Bridge ID** становится корневым. Поэтому по факту выбирается **корневой коммутатор** рандомно (чем ниже **MAC-адрес**).

### Типы сообщений STP

- **BPDU** (**Bridge Protocol Data Unit**): Специальные кадры, которые коммутаторы отправляют друг другу для обмена информацией о состоянии портов и топологии сети. **BPDU** содержат информацию о приоритете коммутатора, идентификаторе порта и стоимости пути до корневого коммутатора.
- **TCN** (**Topology Change Notification**) **BPDU**: это сообщение уведомляет другие коммутаторы о том, что произошли изменения в сети, такие как изменение состояния порта (например, переход порта из состояния **Blocked** в **Forwarding**). Когда коммутатор получает **TCN BPDU**, он передаёт это сообщение дальше к корневому мосту.
- **TCA (Topology Change Acknowledgment) BPDU**: это сообщение используется для подтверждения получения **TCN BPDU**. Когда корневой мост получает уведомление о топологическом изменении (**TCN BPDU**), он отправляет подтверждение (**TCA BPDU**), чтобы уведомить коммутатор-инициатор, что изменение было принято и обработано.

-------

## Разновидности STP

- **RSTP** (**Rapid Spanning Tree Protocol**, *IEEE 802.1w*): Улучшенная версия **STP**, которая *сокращает время сходимости сети после изменений топологии* с нескольких десятков секунд до нескольких секунд. В отличие от **STP** все свичи шлют **BPDU**. Система становится проактивной, заранее просчитывающей “пути отхода” еще до появления проблемы. Смысл простой: для того, чтобы в случае отказа основного переключится на резервный линк, **RSTP** не нужно заново просчитывать топологию, он просто переключится на запасной, заранее просчитанный, так как добавляется новая роль порта **Backup (резервный) **и **Alternate** (**альтернативный путь**). 
- **MSTP** (**Multiple Spanning Tree Protocol**, *IEEE 802.1s*): Позволяет создать несколько экземпляров **STP** для разных групп **VLAN**, что помогает более эффективно управлять трафиком в больших сетях. **MSTP** позволяет создавать столько процесов **STP**, сколько у нас логических топологий, и распределять по ним вланы. 
- **PVST+** (**Per-VLAN Spanning Tree Plus**): Протокол **Cisco**, который позволяет запустить отдельное дерево **STP** для каждого **VLAN**, обеспечивая более гибкое управление сетевой топологией, работает как с **ISL-транком**, так и с **802.1q**.

--------------
